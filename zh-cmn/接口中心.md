# 接口中心

## 接口说明

接口中心提供用户帐号信息管理，提供注册以及修改密码等服务。

设备管理包括设备的添加，设备分组等设备信息服务。


设备控制提供对设备开关、颜色、色温、亮度的调整，设备的分享以及设备定时器的设置。

接口地址中的区域可根据实际用户所属地区更改，目前已有区域: cn、as、eu、us

中国内陆区域建议使用: https://cn-api.coolkit.cn:8080 -> .cn域名后缀

其他地区建议使用: https://{区域}-api.coolkit.cc:8080 -> .cc域名后缀

## 区域管理

### 查询当前区域

返回app当前所属的区域。区域主要作用是让设备就近连接到服务器，拥有更好的设备体验。帐号注册时确定用户所属区域，随之用户下的设备也会连接到用户对应区域的服务器。

比如: 用户在cn区域，帐号注册到eu区域，随之设备也会连接到eu区域服务器，有可能会出现设备响应慢。

- 接口路径: https://api.coolkit.cc:8080/api/user/region
- 请求方法: get

**请求参数:**

Headers: 

| 名称 | 参数值 | 允许为空 | 示例 |
| :--- | :--- | :--- | :--- |
| Authorization | Sign+空格+签名值 | N | Sign Qbd+knKCUb8LAP6yMv1SSqYwmm1vDIxG3rHeq1Ul+ |
| Content-Type | application/json | N | application/json |

Params: 

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| country_code | string | Y | [国家或地区码](http://www.yadexp.com/yadexp/209/d.htm) |
| appid | string | N | APPID |
| nonce | string | N | 8位字母数字随机数 |
| ts | number | N | 时间戳精确到秒 |
| version | number | N | 接口版本: 8 |

示例: 

```json
https://api.coolkit.cc:8080/api/user/region?country_code=86&appid=McFJj4Noke1mGDZCR1QarGW7P9Ycp0Vr&nonce=q3wz95p6&ts=1558004249&version=8
```

**响应参数:**

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| region | string | N | 区域 |
| error | number | N | 错误码 |
| requestid| string| Y| ts+"-"+nonce |

**返回示例:**

```json
{
    "region":"cn",
    "error":0,
    "requestid": "q3wz95p6-1558004249"
}
```

## 账号管理

### 验证码

验证码为注册、重置密码、找回密码的用户安全认证校验。

- 接口地址: https://{区域}-api.coolkit.cc:8080/api/sms
- 请求方法: post

**请求参数:**

Headers: 

| 名称 | 参数值 | 允许为空 | 示例 |
| :--- | :--- | :--- | :--- |
| Authorization | Sign+空格+签名值 | N | Sign Qbd+knKCUb8LAP6yMv1SSqYwmm1vDIxG3rHeq1Ul+is= |
| Content-Type | application/json | N | application/json |

Body: 

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| sendType | string | N | "0"注册；"1"重置密码；"3"申请注销账号；"4"微信验证码注册登录 |
| email | string | Y | 邮箱账号 |
| to | string | Y | 手机账号，带国家码，格式: +8615815725225 (+86中国) |
| appid | string | N | APPID |
| nonce | string | N | 8位字母数字随机数 |
| ts | number | N | 时间戳精确到秒 |
| version | number | N | 接口版本: 8 |

示例: 

```json
{
    "sendType":"0",
    "to":"+8613123456789",// or "email":"test@test.com"
    "appid":"McFJj4Noke1mGDZCR1QarGW7P9Ycp0Vr",
    "ts": 1558004249,
    "version":8,
    "nonce":"asbsedwq"
}
```

备注: 

- 接口地址中的区域可根据实际用户所属地区更改，目前已有区域: cn、as、eu、us
- 中国内陆区域建议使用: https://cn-api.coolkit.cn:8080 -> .cn域名后缀
- 其他地区建议使用: https://{区域}-api.coolkit.cc:8080 -> .cc域名后缀
- 签名值计算规则请查看:「[开发通用说明](/#/zh-cmn/开发文档?id=通用说明)」。
- 注意email和to不会同时存在，邮箱接收验证码只传email，电话号码接收验证码只传「to」。

**响应参数:**

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| error | number | N | 错误码 |
| region | string | Y | 账号不在当前区域会返回 |
| msg | string | Y | 错误原因 |

错误码: 

0: 操作成功  
301: 用户在其他大区，需要客户端结合region重定向，重新连接  
400: 参数错误  
401: 账号不存在  
409: 用户已经注册  
504: 发送失败  
160038: 发送频率高，超过限制  

**返回示例:**

```json
{
    "error": 0
}
```

### 注册账号

易微联账号注册。

- 接口地址: https://{区域}-api.coolkit.cc:8080/api/user/register
- 请求方法: post

**请求参数:**

Headers: 

| 名称 | 参数值 | 允许为空 | 示例 |
| :--- | :--- | :--- | :--- |
| Authorization | Sign+空格+签名值 | N | Sign 7z8pd9cGSxizuAm5kl4TmRcRzMuVQK/6Ye3DREUnM5E= |
| Content-Type | application/json | N | application/json |

Body: 

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| email | string | Y | 邮箱 |
| phoneNumber | string | Y | 手机号码 |
| verificationCode | string | N | 验证码 |
| password | string | N | 注册密码 |
| appid | string | N | APPID |
| nonce | string | N | 8位字母数字随机数 |
| ts | number | N | 时间戳精确到秒 |
| version | number | N | 接口版本: 8 |

示例: 

```json
{
    "verificationCode":"1234",
    "phoneNumber":"+861312345678",// or "email":"test@test.com"
    "email":"",
    "password":"12345678",
    "appid":"McFJj4Noke1mGDZCR1QarGW7P9Ycp0Vr",
    "ts": 1558004249,
    "version":8,
    "nonce":"asbsedwq"
}
```

**响应参数:**

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| error | number | Y | 失败时返回，且只会返回error |
| at | string | Y | Access Token |
| rt | string | Y | Refresh Token |
| user | object | Y | 用户信息 |
| region | string | Y | 注册区域 |

User说明: 

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| phoneNumber | string | N | 用户手机号，带国家码格式:+8613123456789 (+86中国) |
| appId | string | N | 注册时用的APPID |
| lang | string | N | 语言 |
| online | boolean | N | 在线状态true:在线 false:不在线 |
| onlineTime | boolean | N | 在线状态true:在线 false:不在线 |
| apikey | string | N | 用户apikey | 
| nickname | string | Y | 用户昵称 | 
| createdAt | date | N | 注册时间 |  

2019-06-05添加说明: 

目前分区情况: 中国区+86号码、非中国区号码正常走对应区域的注册流程，中国区非+86号码和邮箱号码接口内部请求注册到as区域。

错误码: 

401: 获取认证token失败  
498: 验证码错误  
409: 用户已存在  
操作成功: 不返回error  

**返回示例:**   

```json
{
    "at":"074e8af6f5f10183647a6a4f5b51fdc6788f617a",
    "rt":"24670a9e493ba18cf5d9750f14505705824fcfd9",
    "user":{
        "_id":"5c984cd3dc8295fa0ef3e592",
        "phoneNumber":"+8613123456789",
        "appId":"McFJj4Noke1mGDZCR1QarGW7P9Ycp0Vr",
        "lang":"cn",
        "online":false,
        "onlineTime":"2019-05-16T10:48:42.091Z",
        "ip":"110.110.110.110",
        "location":"广东",
        "offlineTime":"2019-05-16T10:51:22.090Z",
        "appInfos":[
            {
                "appVersion":"3.12.0",
                "os":"android"
            }
        ],
        "nickname":"eWelink",
        "createdAt":"2019-03-25T03:36:51.335Z",
        "apikey":"95da0fea-5692-469a-c562-4dd5ee9a51f1"
    },
    "region":"cn"
}
```

### 账号登录

易微联账号登录，设备管理控制的前置条件。

- 接口地址: https://{区域}-api.coolkit.cc:8080/api/user/login
- 请求方法: post

**请求参数:**

Headers: 

| 名称 | 参数值 | 允许为空 | 示例 |
| :--- | :--- | :--- | :--- |
| Authorization | Sign+空格+签名值 | N | Sign Qbd+knKCUb8LAP6yMv1SSqYwmm1vDIxG3rHeq1Ul+ |
| Content-Type | application/json | N | application/json |

Body: 

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| phoneNumber | string | - | 登录手机（优先） |
| email | string | - | 登录邮箱 |
| password | string | N | 登录密码 |
| appid | string | N | APPID |
| nonce | string | N | 8位字母数字随机数 |
| ts | number | N | 时间戳精确到秒 |
| version | number | N | 接口版本: 8 |

示例: 

```json
{
    "appid":"McFJj4Noke1mGDZCR1QarGW7P9Ycp0Vr",
    "phoneNumber":"+8613185260282",
    "password":"12345678",
    "ts": 1558004249,
    "version":8,
    "nonce":"asbsedwq"
}
```

备注: 

- 接口地址中的区域可根据实际用户所属地区更改，目前已有区域: cn、as、eu、us
- 中国内陆区域建议使用: https://cn-api.coolkit.cn:8080 -> .cn域名后缀
- 其他地区建议使用: https://{区域}-api.coolkit.cc:8080 -> .cc域名后缀
- 签名值计算规则请查看 「[开发通用说明](https://www.yuque.com/nocmt/oadlgi/zcuit1#5Iu8I)」。

**响应参数:**

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| error | number | Y | 失败时返回，且只会返回error |
| at | string | Y | Access Token |
| rt | string | Y | Refresh Token |
| user | object | Y | 用户信息 |
| region | string | Y | 注册区域 |

User说明: 见注册接口

错误码: 

400: 缺少参数  
301: 用户在其他大区，需要客户端查询区域接口重定向  
401: 用户名密码错误  
402: 邮箱未激活  
404: 用户不存在  
406: 认证失败（APPID错误或参数不完整）  

**返回示例:**

```json
{
    "at":"a527297584f1ca030579a90d2e800481e22e850a",
    "rt":"24670a9e493ba18cf5d9750f14505705824fcfd9",
    "user":{
        "_id":"5c984cd3dc8295fa0ef3e592",
        "phoneNumber":"+8613185260282",
        "appId":"1xMdjbmOBYctEJfye4EjFLR2M6YpYyyJ",
        "lang":"cn",
        "online":false,
        "onlineTime":"2019-05-16T10:48:42.091Z",
        "ip":"113.87.160.95",
        "location":"广东",
        "offlineTime":"2019-05-16T10:51:22.090Z",
        "appInfos":[
            {
                "appVersion":"3.6.1",
                "os":"android"
            }
        ],
        "nickname":"coco",
        "createdAt":"2019-03-25T03:36:51.335Z",
        "apikey":"95da0fea-6834-469a-b247-4dd5ee9a51f1"
    },
    "region":"cn"
}
```

备注: 

- at为其他请求必须携带的参数，代替Authorization的值（Authorization: Bearer+空格+at）。
- rt存在的目的是刷新at。
- region为账号注册所在区域。

### 找回密码

忘记密码的情况下，使用注册的帐号接收验证码，重新设置密码。

- 接口路径: https://{区域}-api.coolkit.cc:8080/api/user/password/reset
- 请求方法: post

**请求参数:**

Headers: 

| 名称 | 参数值 | 允许为空 | 示例 |
| :--- | :--- | :--- | :--- |
| Authorization | Sign+空格+签名值 | N | Sign 1zMaXhUQsSORdLo3mfA5igVSbrlkdDIStLtInz5Bjeg= |
| Content-Type | application/json | N | application/json |

Body: 

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| verificationCode | string | N | 验证码 |
| email | string | Y | 邮箱账号 |
| phoneNumber | string | Y | 手机账号 |
| password | string | N | 新密码 |
| appid | string | N | APPID |
| nonce | string | N | 8位字母数字随机数 |
| ts | number | N | 时间戳精确到秒 |
| version | number | N | 接口版本: 8 |

示例: 

```json
{
    "verificationCode": "1234",
    "phoneNumber":"+8613123456789",
    "password":"12345678",
    "appid":"McFJj4Noke1mGDZCR1QarGW7P9Ycp0Vr",
    "ts": 1558004249,
    "version":8,
    "nonce":"q3wz95p6"
}
```

**响应参数:**

| 名称   | 类型   | 允许为空 | 说明                        |
| :--- | :--- | :--- | :--- |
| error  | string | Y        | 失败时返回，且只会返回error |
| at     | string | Y        | Access Token                |
| rt     | string | Y        | Refresh Token               |
| user   | object | Y        | 用户信息                    |
| region | string | Y        | 注册区域                    |

User说明: 见注册接口

错误码: 

0: 操作成功  
400: 参数错误  
401: 认证失败  
403: 没有权限  
498: 验证码不正确  


**返回示例:**   

```json
{
    "at":"354da69e2a30706f7c4c15e3eda0848d42c6a1bd",
    "rt":"f82cbbfb0330d99d367835a7fd0a19c65513c4b4",
    "user":{
        "_id":"5c984cd3dc8295fa0ef3e592",
        "phoneNumber":"+8613185260282",
        "appId":"1xMdjbmOBYctEJfye4EjFLR2M6YpYyyJ",
        "lang":"cn",
        "online":false,
        "onlineTime":"2019-05-16T10:48:42.091Z",
        "ip":"113.87.160.95",
        "location":"广东",
        "offlineTime":"2019-05-16T10:51:22.090Z",
        "appInfos":[
            {
                "appVersion":"3.6.1",
                "os":"android"
            }
        ],
        "nickname":"coco",
        "createdAt":"2019-03-25T03:36:51.335Z",
        "apikey":"95da0fea-6834-469a-b247-4dd5ee9a51f1"
    },
    "region":"cn"
}
```
### 修改密码

用户在已知原密码的情况下，可以直接修改密码，不用获取验证码。

- 接口路径: https://{区域}-api.coolkit.cc:8080/api/user/password
- 请求方法: post

**请求参数:**

Headers: 

| 名称 | 参数值 | 允许为空 | 示例 |
| :--- | :--- | :--- | :--- |
| Authorization | Bearer+空格+at | N | Bearer 074e8af6f5f10183647a6a4f5b51fdc6788f617a |
| Content-Type | application/json | N | application/json |

Body: 

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| oldPassword | string | N | 旧的密码 |
| newPassword | string | N | 新的密码 |
| appid | string | N | APPID |
| nonce | string | N | 8位字母数字随机数 |
| ts | number | N | 时间戳精确到秒 |
| version | number | N | 接口版本: 8 |

示例: 

```json
{
    "oldPassword":"12345678",
    "newPassword":"123456789",
    "appid":"McFJj4Noke1mGDZCR1QarGW7P9Ycp0Vr",
    "ts":15452192511,
    "version":8,
    "nonce":"asbsedwq"
}
```
**响应参数:**

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| error | string | Y | 错误信息，只要返回有error表示失败 |
| message | string | Y | 返回message表示修改密码成功 |

遗留原因导致这样的问题，目前新接口已规范返回参数。

错误码: 

400: 参数错误  
401: 认证失败  

**返回示例:**

```json
{
    "message": "Change password is success!"
}
```

### 认证刷新

Acesss Token默认30天失效，此时不用用户重新登录获取Acesss Token，而是客户端使用 Refresh Token请求服务器刷新获取新Acesss Token。

- 接口路径: https://{区域}-api.coolkit.cc:8080/api/user/refresh
- 请求方法: get

**请求参数:**

Headers: 

| 名称 | 参数值 | 允许为空 | 示例 |
| :--- | :--- | :--- | :--- |
| Authorization | Sign+空格+签名值 | N | Sign 3uvYDwdnrpMmToyGpJdm8z4qmkbgI4PWayoJd11t4I4= |
| Content-Type | application/json | N | application/json |

Params: 

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| rt | string | N | Refresh Token |
| grantType | string | N | 固定参数: refresh |
| appid | string | N | APPID |
| nonce | string | N | 8位字母数字随机数 |
| ts | number | N | 时间戳精确到秒 |
| version | number | N | 接口版本: 8 |

示例: 

```json
https://cn-api.coolkit.cn:8080/api/user/refresh?grantType=refresh&rt=24670a9e493ba18cf5d9750f14505705824fcfd9&appid=McFJj4Noke1mGDZCR1QarGW7P9Ycp0Vr&ts=1558004249&version=8&nonce=asbsedwq
```

**响应参数:**

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| error | string | Y | 失败时返回，且只会返回error |
| at | string | Y | Access Token |
| rt | string | Y | Refresh Token |
| user | object | Y | 用户信息 |
| region | string | Y | 注册区域 |

错误码: 

400: 参数错误  
401: 认证失败  
402: rt失效  

**返回示例:** 

```json
{
    "at":"174e8af6f5f10183647a6a4f5b51fdc6788f6172",
    "rt":"24670a9e493ba18cf5d9750f14505705824fcfd9",
    "user":{
        "_id":"5c984cd3dc8295fa0ef3e592",
        "phoneNumber":"+8613123456789",
        "appId":"McFJj4Noke1mGDZCR1QarGW7P9Ycp0Vr",
        "lang":"cn",
        "online":false,
        "onlineTime":"2019-05-16T10:48:42.091Z",
        "ip":"110.110.110.110",
        "location":"广东",
        "offlineTime":"2019-05-16T10:51:22.090Z",
        "appInfos":[
            {
                "appVersion":"3.12.0",
                "os":"android"
            }
        ],
        "nickname":"eWelink",
        "createdAt":"2019-03-25T03:36:51.335Z",
        "apikey":"95da0fea-5692-469a-c562-4dd5ee9a51f1"
    },
    "region":"cn"
}
```

## 设备管理

### 获取设备列表

- 接口路径: https://{区域}-api.coolkit.cc:8080/api/user/device
- 请求方法: get

**请求参数:**

Headers: 

| 名称 | 参数值 | 允许为空 | 示例 |
| :--- | :--- | :--- | :--- |
| Authorization | Bearer+空格+at | N | Bearer 074e8af6f5f10183647a6a4f5b51fdc6788f617a |
| Content-Type | application/json | N | application/json |

Params: 

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| lang | string | Y | cn 响应返回中文信息；en 响应返回英文信息 |
| appid | string | N | APPID |
| nonce | string | N | 8位字母数字随机数 |
| ts | number | N | 时间戳精确到秒 |
| version | number | N | 接口版本: 8 |
| getTags | number | Y | 0: 不返回标签内容；1：返回标签内容；默认为0 |

示例: 

```json
https://cn-api.coolkit.cn:8080/api/user/device?lang=cn&appid=McFJj4Noke1mGDZCR1QarGW7P9Ycp0Vr&ts=1558004249&version=8&nonce=asbsedwq
```

**响应参数:**

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| error | number | Y | 状态码，error: 0 操作成功 |
| devicelist | array | N | 设备列表信息，成功才返回 |

**备注: 如果返回为空列表: []，说明账号下没有设备或者该设备品牌没有关联到您的APPID，需要联系对接销售，获得临时测试授权，后期正式授权接入事项可咨询对接销售。**

device说明: 

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| name | N | string | 设备名称 |
| type | N | string | 类型 |
| deviceid | N | string | 设备id |
| apikey | N | string | 绑定的用户apikey |
| extra | N | object | 关联表引用信息 |
| onlineTime | N | string | 设备最后上线时间 |
| ip | N | string | 设备上线的ip地址 |
| location | N | string | 设备上线的地方 |
| settings | N | object | 设备配置信息 |
| groups | N | list | 设备所属的分组ID，设备可以属于多个分组。如果不属于任何分组，则返回空数组[] |
| params | N | object | 设备参数 |
| online | N | boolean | 设备是否在线 |
| createdAt | N | date | 设备添加时间 |
| sharedTo | Y | object | 分享列表 |
| devicekey | N | string | 设备apikey（重要） |
| deviceUrl | Y | string | 设备详情界面url |
| brandName | N | string | 品牌 |
| productModel | N | string | 产品型号 |
| showBrand | N | boolean | 是否展示品牌和产品型号 |
| uiid | N | number | 设备ui的id（重要） |

**返回示例:**

```json
[
    {
        "_id": "***************",
        "name": "我的设备213ac8",
        "type": "10",
        "deviceid": "1000213ac8",
        "apikey": "3541f7af-*ec5-4502-9bf3-eb4b09e9e12*",
        "extra": {
            "_id": "***************",
            "extra": {
                "model": "PSA-B11-GL",
                "ui": "单通道开关",
                "description": "WWJG001111",
                "manufacturer": "深圳创易智能系统有限公司",
                "mac": "**:**:**:**:**:**",
                "apmac": "**:**:**:**:**:**",
                "modelInfo": "***************",
                "brandId": "***************",
                "uiid": 6,
                "staMac": "**:**:**:**:**:**",
                "chipid": "********"
            }
        },
        "__v": 0,
        "onlineTime": "2019-10-15T07:22:14.361Z",
        "ip": "110.110.110.110",
        "location": "广东",
        "settings": {
            "opsNotify": 0,
            "opsHistory": 1,
            "alarmNotify": 1,
            "wxAlarmNotify": 0,
            "wxOpsNotify": 0,
            "wxDoorbellNotify": 0,
            "appDoorbellNotify": 1
        },
        "devGroups": [],
        "groups": [],
        "params": {
            "pulseWidth": 500,
            "pulse": "off",
            "init": 1,
            "startup": "off",
            "staMac": "**:**:**:**:**:**",
            "rssi": -50,
            "fwVersion": "3.0.1",
            "switch": "off",
            "sledOnline": "on",
            "version": 8
        },
        "online": true,
        "createdAt": "2019-10-15T07:22:11.700Z",
        "group": "",
        "sharedTo": [],
        "devicekey": "***************",
        "deviceUrl": "",
        "brandName": "Maker",
        "showBrand": true,
        "brandLogoUrl": "",
        "productModel": "Sonoff basic R2",
        "devConfig": {},
        "uiid": 6
    },
]
```
### 单个设备查询

通过deviceid获取单个设备数据。

- 接口路径: https://{区域}-api.coolkit.cc:8080/api/user/device/{设备ID}
- 请求方法: get

**请求参数:**

Headers: 

| 名称 | 参数值 | 允许为空 | 示例 |
| :--- | :--- | :--- | :--- |
| Authorization | Bearer+空格+at | N | Bearer 074e8af6f5f10183647a6a4f5b51fdc6788f617a |
| Content-Type | application/json | N | application/json |

Params: 

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| deviceid | string | N | 查询的设备ID |
| appid | string | N | APPID |
| nonce | string | N | 8位字母数字随机数 |
| ts | number | N | 时间戳精确到秒 |
| version | number | N | 接口版本: 8 |

示例: 

```json
https://cn-api.coolkit.cn:8080/api/user/device/1000000001?deviceid=&1000000001&appid=McFJj4Noke1mGDZCR1QarGW7P9Ycp0Vr&ts=1558004249&version=8&nonce=asbsedwq
```

**响应参数:**

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| error | number | Y | 错误码 |
| device | object | Y | 设备信息，成功才返回 |

错误码: 

0: 操作成功  
400: 参数错误  
401: 认证失败  

**返回示例:**

```json
{
   "name": "我的设备00001",
   "deviceid": "100000001"
   ...
}
```

### 添加WiFi设备

此接口传参数据皆为配网时获取，APP配网过程中将设备添加到用户帐号下，服务端返回添加成功的设备数据。

- 接口路径: https://{区域}-api.coolkit.cc:8080/api/user/device/add
- 请求方法: post

**请求参数:**

Headers: 

| 名称 | 参数值 | 允许为空 | 示例 |
| :--- | :--- | :--- | :--- |
| Authorization | Bearer+空格+at | N | Bearer 074e8af6f5f10183647a6a4f5b51fdc6788f617a |
| Content-Type | application/json | N | application/json |

Body: 

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| deviceid | string | N | 设备ID |
| apikey | string | N | 设备apikey |
| name | string | N | 设备名称 |
| isSub | number | N | 是否为子设备（0不是；1是） |
| subDeviceId | string | - | 子设备的设备ID，与isSub共存 |
| chipid | string | Y | 设备芯片ID |
| appid | string | N | APPID |
| nonce | string | N | 8位字母数字随机数 |
| ts | number | N | 时间戳精确到秒 |
| version | number | N | 接口版本: 8 |

示例: 

```json
{
    "deviceid":"100000001",
    "apikey":"xxxx-xxxx-xxx",
    "name":"我的设备0001",
	  "chipid":"zaqozs",
    "appid":"McFJj4Noke1mGDZCR1QarGW7P9Ycp0Vr",
    "ts":15452192511,
    "version":8,
    "nonce":"asbsedwq"
}
```

**响应参数:**

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| code| number  | Y | 错误码 |
| error | number | Y | 错误信息 |
| device | object | Y | 设备信息，成功才返回 |

错误码: 无

**返回示例:**

```json
{
   "name": "我的设备00001",
   "deviceid":"100000001"
   ...
}
```

### 添加GSM设备

添加GSM设备传参的内容来自于设备上贴的二维码，里面有ID。

- 接口路径: https://{区域}-api.coolkit.cc:8080/api/user/device/addGsm
- 请求方法: post

**请求参数:**

Headers: 

| 名称 | 参数值 | 允许为空 | 示例 |
| :--- | :--- | :--- | :--- |
| Authorization | Bearer+空格+at | N | Bearer 074e8af6f5f10183647a6a4f5b51fdc6788f617a |
| Content-Type | application/json | N | application/json |

Body: 

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| id | string | N | 设备gsmId，从GSM设备二维码中解析获取 |
| name | string | N | 设备名称 |
| appid | string | N | APPID |
| nonce | string | N | 8位字母数字随机数 |
| ts | number | N | 时间戳精确到秒 |
| version | number | N | 接口版本: 8 |

示例: 

```json
{
    "id":"xxxxxxxxxxxxxxxxxxxx",
    "name":"我的设备0001",
    "appid":"McFJj4Noke1mGDZCR1QarGW7P9Ycp0Vr",
    "ts":15452192511,
    "version":8,
    "nonce":"asbsedwq"
}
```

**响应参数:**

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| code | number | Y | 状态码，失败必返回 |
| error | number | Y | 错误信息，失败必返回 |
| device | object | Y | 设备信息，成功才返回 |

错误码: 

- Device name, id and apikey must not be empty! (传递的参数不完整) code: 400  
- Invalid device id format! (设备id不符合规范)     code: 401  
- Add device failed! (添加设备失败)   code: 500  
- fd data is null (设备不存在)  code: 404  
- Device not belong to this brand! (设备不属于该品牌)  code: 403  
- Device has already been added!' : 'Device belongs to other user! (设备已经被添加)  code: 409  
- find brand failed! (查找品牌失败 ps: 设备列表展现字段)  code: 502  
- find modelInfo failed! (查找产品型号失败 ps: 设备列表展现字段)  code: 503  

**返回示例:**

```json
{
   "name": "我的设备00001",
   "deviceid":"100000001"
   ...
}
```

**错误示例:**

```json
{
    "code":404,
    "error":"fd data is null"
}
```

### 删除普通设备

删除帐号下的易微联设备。

- 接口路径: https://{区域}-api.coolkit.cc:8080/api/user/device/{设备ID}
- 请求方法: delete

**请求参数:**

Headers: 

| 名称 | 参数值 | 允许为空 | 示例 |
| :--- | :--- | :--- | :--- |
| Authorization | Bearer+空格+at | N | Bearer 074e8af6f5f10183647a6a4f5b51fdc6788f617a |
| Content-Type | application/json | N | application/json |

Params: 

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| deviceid | string | N | 设备ID |
| apikey | string | N | 用户apikey |
| isSub | number | N | 是否为子设备（0不是；1是） |
| subDeviceId | string | - | 子设备的设备ID，与isSub共存 |
| appid | string | N | APPID |
| nonce | string | N | 8位字母数字随机数 |
| ts | number | N | 时间戳精确到秒 |
| version | number | N | 接口版本: 8 |

示例: 

```json
https://cn-api.coolkit.cn:8080/api/user/device/1000000001?deviceid=&1000000001&appid=McFJj4Noke1mGDZCR1QarGW7P9Ycp0Vr&ts=1558004249&version=8&nonce=asbsedwq
```

**响应参数:**

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| device | object | Y | 设备信息，成功才返回 |

错误码: 无

**返回示例:**

```json
{
   "name": "我的设备00001",
   "deviceid":"100000001"
   ...
}
```

### 修改设备名称

修改单通道设备的名称。

- 接口路径: https://{区域}-api.coolkit.cc:8080/api/user/device/{设备ID}
- 请求方法: post

**请求参数:**

Headers: 

| 名称 | 参数值 | 允许为空 | 示例 |
| :--- | :--- | :--- | :--- |
| Authorization | Bearer+空格+at | N | Bearer 074e8af6f5f10183647a6a4f5b51fdc6788f617a |
| Content-Type | application/json | N | application/json |

Body: 

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| deviceid | string | N | 设备ID |
| apikey | string | N | 用户apikey |
| name | string | N | 设备名称 |
| group | string | N | 默认空字符 |
| appid | string | N | APPID |
| nonce | string | N | 8位字母数字随机数 |
| ts | number | N | 时间戳精确到秒 |
| version | number | N | 接口版本: 8 |

示例: 

```json
{
    "deviceid":"100000001",
    "apikey":"xxxx-xxxx-xxx",
    "name":"我的设备0002",
	"group": "",
    "appid":"McFJj4Noke1mGDZCR1QarGW7P9Ycp0Vr",
    "ts":15452192511,
    "version":8,
    "nonce":"asbsedwq"
}
```

**响应参数:**

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| error | number | N | 错误码 |
| device | object | Y | 设备信息，成功才返回 |

错误码: 

0: 成功

**返回示例:**

```json
{
   "error": 0,
   "deviceid":"1000000001"
}
```

### 修改子通道名称

修改多通道设备的通道名称。

- 接口路径: https://{区域}-api.coolkit.cc:8080/api/user/tags
- 请求方法: post

**请求参数:**

Headers: 

| 名称 | 参数值 | 允许为空 | 示例 |
| :--- | :--- | :--- | :--- |
| Authorization | Bearer+空格+at | N | Bearer 074e8af6f5f10183647a6a4f5b51fdc6788f617a |
| Content-Type | application/json | N | application/json |

Body: 

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| deviceid | string | N | 设备ID |
| apikey | string | N | 用户apikey |
| appid | string | N | APPID |
| nonce | string | N | 8位字母数字随机数 |
| ts | number | N | 时间戳精确到秒 |
| version | number | N | 接口版本: 8 |
| key | string | N | 固定参数: ck_channel_name |
| value | object | N | {k:v}格式对象 |

示例: 

```json
{
    "deviceid":"100000001",
    "apikey":"xxxx-xxxx-xxx",
    "key":"ck_channel_name",
  	"value":{
      "0": "通道1", 
      "1": "通道2", 
      "2": "通道3", 
      "3": "通道4"
    },
    "appid":"McFJj4Noke1mGDZCR1QarGW7P9Ycp0Vr",
    "ts":15452192511,
    "version":8,
    "nonce":"asbsedwq"
}
```

**响应参数:**

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| error | number | N | 错误码 |

错误码: 

0: 操作成功  
400:参数错误  
401: 认证失败  

**返回示例:**

```json
{
   "error": 0
}
```

### 设备操作记录

根据设备ID和时间戳查询开关记录。

- 接口路径: https://{区域}-api.coolkit.cc:8080/api/user/deviceHistory
- 请求方法: post

**请求参数:**

Headers: 

| 名称 | 参数值 | 允许为空 | 示例 |
| :--- | :--- | :--- | :--- |
| Authorization | Bearer+空格+at | N | Bearer 074e8af6f5f10183647a6a4f5b51fdc6788f617a |
| Content-Type | application/json | N | application/json |

Body: 

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| startTime | long | Y | 开始秒级时间戳 |
| endTime | string | Y | 结束秒级时间戳 |
| pageSize | string | Y | 如果有需要可以指定每次返回的条数,与currentPage必须一起出现 |
| currentPage | string | Y | 当前第几页与pageSize必须一起出现 |
| deviceid | string | N | 设备ID |
| apikey | string | N | 用户apikey |
| appid | string | N | APPID |
| nonce | string | N | 8位字母数字随机数 |
| ts | number | N | 时间戳精确到秒 |
| version | number | N | 接口版本: 8 |

示例: 

```json
{
    "appid":"xxxx",
    "apikey":"xxx",
    "ts":1579331197,
    "nonce":"p3XGuMIP",
    "version":8,
    "startTime":1582822861,
    "deviceid":"10000267ee"
}
```

**响应参数:**

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| error | number | N | 错误码 |
| deviceHistories | array | N | 设备历史操作记录 |

History说明: 

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| hid | string | N | 设备历史操作记录标记 |
| userAgent | string | N | 操作来源 |
| apikey | string | N | 操作用户apikey |
| opsAccount | string | N | 如果是app端的操作，返回操作人的账号（有可能是分享用户的） |
| opsSwitchs | String[] | Y	| 记录被操作的通道值。如果是单通道就只有1个元素，值为”switch” |
| opsTime | string | N | 操作时间 |
| deviceid | string | N | 设备ID |
| opsSwitchs | string | N | 操作内容 |
| opsDate | number | N | 操作日期 |
| ttlTime | number | N | 秒级时间戳 |
| subType | number | N | 操作子类型，用来细化具体的操作，例如智能锁 |
| request | string | N | 原始指令内容 |
| type | number | N | 操作来源: 0/或者空:普通设备1: bridge操作记录；2:门铃信息；3: 智能锁操作记录；4: echo；5: google home；6: 天猫精灵；7: ifttt；1.2.3属于历史遗留，后续除非有新的平台接入，不再新增类型 |

**返回示例:**   

```json
{
    "error": 0,
    "deviceHistories": [
        {
            "hid": "xxxx_10000267ee",
            "userAgent": "device",
            "apikey": "xxxx",
            "opsTime": "2020-03-05T05:03:42.300Z",
            "deviceid": "10000267ee",
            "opsSwitchs": "[{\"switch\":\"off\"}]",
            "opsDate": 20200305,
            "ttlTime": 1591160622,
            "subType": 0,
            "request": "{\"action\":\"update\",\"deviceid\":\"10000267ee\",\"apikey\":\"xxxx\",\"userAgent\":\"device\",\"ts\":0,\"remoteAddress\":\"115.218.202.233\",\"recServer\":\"172.31.20.198\",\"socketid\":\"02ccfcfffef80d5c-000003b5-0b224d65-9c096bca8df40acd-b3dd84bc\",\"msgtime\":1583384622298,\"params\":{\"switch\":\"off\"},\"seq\":\"264\"}",
            "type": 0
        }
    ]
}
```

### 新增设备分组

新增设备分组，同时支持分组排序。

- 接口路径: https://{区域}-api.coolkit.cc:8080/api/group
- 请求方法: post

**请求参数:**

Headers: 

| 名称 | 参数值 | 允许为空 | 示例 |
| :--- | :--- | :--- | :--- |
| Authorization | Bearer+空格+at | N | Bearer 074e8af6f5f10183647a6a4f5b51fdc6788f617a |
| Content-Type | application/json | N | application/json |

Body: 

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| index | number | N | 分组顺序 |
| name | string | N | 分组名称 |
| groupType | number | N | 固定参数: 0 |
| apikey | string | N | 用户apikey（可从登陆页面获取） |
| appid | string | N | APPID |
| nonce | string | N | 8位字母数字随机数 |
| ts | number | N | 时间戳精确到秒 |
| version | number | N | 接口版本: 8 |

示例: 

```json
{
    "index":0,
    "apikey":"xxxx-xxxx-xxx",
    "name":"我的分组-1L",
	"groupType": 0,
    "appid":"McFJj4Noke1mGDZCR1QarGW7P9Ycp0Vr",
    "ts":15452192511,
    "version":8,
    "nonce":"asbsedwq"
}
```

**响应参数:**

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| error | number | N | 错误码 |
| groupid | string | - | 创建成功的分组ID |

错误码: 

0: 操作成功  
400: 参数错误  
401: 认证失败  

**返回示例:**

```json
{
   "error": 0,
   "groupid":"123456789123"
}
```

### 修改设备分组

支持修改分组顺序以及分组名称。

- 接口路径: https://{区域}-api.coolkit.cc:8080/api/group
- 请求方法: put

**请求参数:**

Headers: 

| 名称 | 参数值 | 允许为空 | 示例 |
| :--- | :--- | :--- | :--- |
| Authorization | Bearer+空格+at | N | Bearer 074e8af6f5f10183647a6a4f5b51fdc6788f617a |
| Content-Type | application/json | N | application/json |

Body: 

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| id | string | N | 分组ID，新增分组和获取分组列表可获得 |
| index | number | N | 分组顺序 |
| name | string | N | 分组名称 |
| groupType | number | N | 固定参数: 0 |
| apikey | string | N | 用户apikey（可从登陆页面获取） |
| appid | string | N | APPID |
| nonce | string | N | 8位字母数字随机数 |
| ts | number | N | 时间戳精确到秒 |
| version | number | N | 接口版本: 8 |

示例: 

```json
{
    "id":"123456789123",
    "index":2,
    "apikey":"xxxx-xxxx-xxx",
    "name":"My group-2L",
    "groupType": 0,
    "appid":"McFJj4Noke1mGDZCR1QarGW7P9Ycp0Vr",
    "ts":15452192511,
    "version":8,
    "nonce":"asbsedwq"
}
```

**响应参数:**


| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| error | number | N | 错误码 |

错误码: 

0: 操作成功  
400: 参数错误  
401: 认证失败  

**返回示例:**

```json
{
   "error": 0
}
```

### 删除设备分组

删除分组后分组下的设备会进入未分组状态。

- 接口路径: https://{区域}-api.coolkit.cc:8080/api/group
- 请求方法: delete

**请求参数:**

Headers: 

| 名称 | 参数值 | 允许为空 | 示例 |
| :--- | :--- | :--- | :--- |
| Authorization | Bearer+空格+at | N | Bearer 074e8af6f5f10183647a6a4f5b51fdc6788f617a |
| Content-Type | application/json | N | application/json |

Params: 

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| id | string | N | 分组ID |
| type | number | N | 固定参数: 0 |
| apikey | string | N | 用户apikey（可从登陆页面获取） |
| appid | string | N | APPID |
| nonce | string | N | 8位字母数字随机数 |
| ts | number | N | 时间戳精确到秒 |
| version | number | N | 接口版本: 8 |

示例: 

```json
https://cn-api.coolkit.cn:8080/api/group?id=123456789123&type=0&apikey=xxxx-xxxx-xxx&appid=McFJj4Noke1mGDZCR1QarGW7P9Ycp0Vr&ts=15452192511&version=8&nonce=asbsedwq
```

**响应参数:**

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| error | number | N | 错误码 |

错误码: 

0: 操作成功  
400: 参数错误  
401: 认证失败  

**返回示例:**

```json
{
   "error": 0
}
```

### 添加设备到分组

给设备进行分组，支持设备在多个分组内，如果目标分组id为空，则表示把设备从分组中移出。

- 接口路径: https://{区域}-api.coolkit.cc:8080/api/group/addDevice
- 请求方法: post

**请求参数:**

Headers: 

| 名称 | 参数值 | 允许为空 | 示例 |
| :--- | :--- | :--- | :--- |
| Authorization | Bearer+空格+at | N | Bearer 074e8af6f5f10183647a6a4f5b51fdc6788f617a |
| Content-Type | application/json | N | application/json |

Body: 

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| deviceinfos | object | N | 设备数组: [device] |
| groupType | number | N | 固定参数: 0 |
| apikey | string | N | 用户apikey（可从登陆页面获取） |
| appid | string | N | APPID |
| nonce | string | N | 8位字母数字随机数 |
| ts | number | N | 时间戳精确到秒 |
| version | number | N | 接口版本: 8 |

device说明: 

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| source_id | string | N | 原分组ID，可以为空 |
| target_id | string | N | 目标分组ID，可以为空 |
| deviceid | string | N | 设备ID |
| type | string | N | 固定参数: 1 |

示例: 

```json
{
    "deviceinfos":[{
        "source_id":"10001",
        "target_id":"10002",
        "deviceid":"10000000001",
        "type":1
    }],
    "groupType":0,
    "apikey":"xxxx-xxxx-xxx",
    "appid":"McFJj4Noke1mGDZCR1QarGW7P9Ycp0Vr",
    "ts":15452192511,
    "version":8,
    "nonce":"asbsedwq"
}
```

**响应参数:**

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| error | number | N | 错误码 |

错误码: 

0: 操作成功  
400: 参数错误  
401: 认证失败  


**返回示例:**

```json
{
   "error": 0
}
```

### 获取分组列表

获取所有分组信息，包括分组的创建时间，分组的排序编号（设备所在分组由设备列表接口提供）。

- 接口路径: https://{区域}-api.coolkit.cc:8080/api/group
- 请求方法: get

**请求参数:**

Headers: 

| 名称 | 参数值 | 允许为空 | 示例 |
| :--- | :--- | :--- | :--- |
| Authorization | Bearer+空格+at | N | Bearer 074e8af6f5f10183647a6a4f5b51fdc6788f617a |
| Content-Type | application/json | N | application/json |

Params: 

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| groupType | number | N | 固定参数: 0 |
| apikey | string | N | 用户apikey（可从登陆页面获取） |
| appid | string | N | APPID |
| nonce | string | N | 8位字母数字随机数 |
| ts | number | N | 时间戳精确到秒 |
| version | number | N | 接口版本: 8 |

示例: 

```json
https://cn-api.coolkit.cn:8080/api/group?groupType=0&apikey=xxxx-xxxx-xxx&appid=McFJj4Noke1mGDZCR1QarGW7P9Ycp0Vr&ts=15452192511&version=8&nonce=asbsedwq
```

**响应参数:**

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| error | number | N | 错误码 |
| groupinfos | object | N | 分组列表: [{k:v},{k:v}] |

groupinfos说明: 

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| id | string | N | 分组ID |
| name | string | N | 分组名称 |
| index | number | N | 分组序号 |
| createdAt | date | N | 分组创建时间 |

错误码: 

0: 操作成功  
400: 参数错误  
401: 认证失败  

**返回示例:**

```json
{
    "groupinfos":[
        {
            "id": "12345678",
            "name": "分组1"
        }
    ],
    "error":0
}
```

## 设备控制

### HTTP : 分配服务（APP）

获得长连接地址和端口以后，才能建立长连接。

- 接口路径: https://{区域}-api.coolkit.cc:8080/dispatch/app
- 请求方法: post

**请求参数:**

Headers: 

| 名称 | 参数值 | 允许为空 | 示例 |
| :--- | :--- | :--- | :--- |
| Authorization | Bearer+空格+at | N | Bearer 074e8af6f5f10183647a6a4f5b51fdc6788f617a |
| Content-Type | application/json | N | application/json |

Body: 

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| accept | string | N | 固定参数: ws |
| appid | string | N | APPID |
| nonce | string | N | 8位字母数字随机数 |
| ts | number | N | 时间戳精确到秒 |
| version | number | N | 接口版本: 8 |

示例: 

```json
{
    "accept":"ws",
    "appid":"McFJj4Noke1mGDZCR1QarGW7P9Ycp0Vr",
    "ts":15452192511,
    "version":8,
    "nonce":"asbsedwq"
}
```

**响应参数:**

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| IP | string | N | 长连接服务器外网IP |
| port | number | N | 长连接服务器外网端口 |
| domain | string | N | 长连接服务器域名。目前只有app端才会返回域名。android客户端尽量选择用ip建立长连接，这样可以减少dns解析带来的问题，js版客户端无法跳过证书检查，那么就只能用IP了。 |
| error | number | N | 成功返回error:0 |
| reason | string | N | 成功返回ok |

错误码: 

0: 成功  
400: 参数错误  
401: 认证不通过（ 提示登录 ）  
402: at过期（ APP会自动刷新access token）  
403: 无权限（ APP提示无权限，比如APP无权访问OTA接口）（401-403认证错误由内部认证系统给出）  

**返回示例:**

```json
{
    "port": 8080,
    "IP": "52.80.19.131",
    "reason": "ok",
    "domain": "cn-pconnect2.coolkit.cc",
    "error": 0
}
```

### WebSocket: 握手

连接建立时的认证，握手分客户端和设备端，此处为客户端的握手。

**注意:**

建立wss连接的时候，客户端会校验访问的域名与证书的域名是否一致，所以默认情况下如果用ip建立连接，会报错，导致建立连接失败。

所以建议客户端跳过证书的域名校验（android和java都可以跳过）。 如果无法跳过证书校验，那么就只能用IP去建立wss连接了。

- URL: wss://IP:Port/api/ws 

以下为参数: 

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| action | string | N | 固定参数: userOnline |
| at | string | N | 登录接口获取的AT |
| apikey | string | N | 用户apikey（可从登陆接口获取） |
| appid | string | N | APPID |
| nonce | string | N | 8位字母数字随机数 |
| ts | number | N | 时间戳精确到秒 |
| userAgent | string | N | 固定参数: app |
| sequence | string | N | 时间戳精确到毫秒 |
| version | number | N | 接口版本: 8 |

示例: 

```json
{
   "action":"userOnline",
   "version":8,
   "ts":1571141259,
   "at":"登录接口获取的AT",
   "userAgent":"app",
   "apikey":"登录接口获取的用户APIKEY",
   "appid":"McFJj4Noke1mGDZCR1QarGW7P9Ycp0Vr",
   "nonce":"2plz69ax",
   "sequence":"毫秒级时间戳，示例: 1571141530100"
}
// 需去掉空格压缩, 不要带多余的逗号
```

**响应参数:**

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| error | number | N | 错误码 |
| apikey | string | N | 用户apikey |
| config | string | Y | 配置信息 |
| sequence | string | N | 时间戳精确到毫秒 |

Config说明: 

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| hbl | number | Y | 心跳开关，是否需要发送心跳。0: 不需要， 1: 需要 |
| hbInterval | number | Y | 心跳间隔，以秒为单位.客户端需要把这个值加上7 作为间隔时间发送保活ping心跳。如果为空，默认以90秒为间隔发送。 |

错误码: 

0: 成功

**返回示例:**

```json
{
  "error": 0,
  "apikey":"用户APIKEY",
  "config":{
  	"hbl":1,
    "hbInterval": 145
  },
  "sequence": "毫秒级时间戳，示例: 1571141530100" // 和发送的一样
}
```

### WebSocket: 设备上线离线通知（APP接收即可）

服务端检测到设备上线或者下线以后，会向app发送通知指令，该指令app端是**被动接收，不需要客户端主动发送**。

参数: 

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| action | string | N | 固定参数: sysmsg |
| apikey | string | N | 用户apikey（可从登陆页面获取） |
| nonce | string | N | 8位字母数字随机数 |
| ts | number | N | 固定参数：0 |
| deviceid | string | N | 设备ID |
| params | object | N | 参数: {k:v} |

示例: 

```json
{
    "action":"sysmsg",
    "deviceid":"100084605c",
    "apikey":"55b7dad6-7bd9-485e-b023-9598d4ba70fa",
    "ts":0,
    "params":{
        "online":false
    }
}
```

### WebSocket: 更新设备状态

**设备状态改变上报update指令后，只要客户端建立了长连接，就可以收到信息，所以建议客户端保持长连接监测设备状态或者发送查询指令获取单个设备状态，而不是定时请求HTTP接口获取设备状态，避免对服务器造成较大的负担。**

更改设备的状态，比如: 定时器、分享、开关状态等。

参数: 

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| action | string | N | 固定参数: update |
| apikey | string | N | 用户apikey（可从登陆页面获取） |
| deviceid | string | N | 设备ID |
| params | object | N | 服务端对于params参数采用透传方式，可能是对象也可能是对象数组。只需要发送期望改变的状态参数 |
| userAgent | string | N| app或者device|
| sequence | string | N| 时间戳精确到毫秒 |
| ts | number | N | 固定参数: 0|

示例: 

```json
{
    "action":"update",
    "deviceid":"100000001",
    "apikey":"用户APIKEY",
    "userAgent":"app",
    "sequence": "1585297259553",
    "ts":0,
    "params":{
        "switch": "on" // 单通道设备
    }
}
```

params说明: 

此参数内容来自于协议文档，不同设备不同协议内容，比如 单通道开关只有一个switch，但多通道设备肯定不止一个switch，灯类设备还能调色调光，参数也有所不同。

协议文档需要向对接销售获取，公版易微联APP未对接设备（无UI）的，如果定制界面需要额外付费，具体情况可咨询对接销售。

**响应参数:**

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| error | number | N  |错误码 |
| apikey | string | Y | 用户apikey |
| deviceid | string | Y | 设备ID |
| sequence | string | N| 时间戳精确到毫秒 |

示例: 

```json
{
    "error": 0,
    "deviceid":"1000000001",
    "apikey": "***************",
    "sequence": "1585297259553"
}
```
错误码: 

504: 设备未回应（离线或者指令错误）

**定时器设置**

总体说明，设备可以添加多个定时器，每一次新增、修改、删除定时器的时候，都要全量提交定时器数组。

比如目前定时器有两个，那么如果再新增一个，那么提交的timers数组里，除了新增的这个定时器信息以外还要包含之前那两个定时器的信息。

timers 参数说明: 

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| enabled | number | N | 是否启用: 0表示不启用;1表示启用 |
| mId | string | N | 用于定时标记，格式为xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxx |
| type | string | N | 设备端使用，单次定时once；重复定时repeat；循环定时duration； |
| coolkit_timer_type | string | N | 客户端使用，单次定时once；重复定时repeat；循环定时duration；延时定时delay |
| at | string | N | 执行时间: 格林尼治时间，也可采用UTC时间 |
| do | object | Y | 要执行的动作 |
| startDo | object | Y | 循环定时专用: 周期开始要执行的动作 |
| endDo | object | Y | 循环定时专用: 随后再执行的动作 |
| period | string | Y | 延时定时专用: 延时时间，单位为分钟 |

示例: 

单次定时，也就是只会执行一次:

```json
"params":{
        "timers":[
            {
                "enabled":1, //1表示启用
                "mId":"c102f00f-db6f-fef0-f296-9dd10fdc2193", //随机，给app用来标记
                "type":"once",  //设备端专用once表示单次定时，repeat重复定时
                "at":"2017-07-24T08:28:00.000Z", //执行的时间 ，注意是GTM时间   0时区
                "do":{   //具体要执行的操作
                    "switch":"on"   //这里是执行打开单通道开关的操作。如果是多通道，这里放的是多通道的开关格式。
                },
                "coolkit_timer_type":"once" //app专用
            }
        ]
    }
```

重复定时: 

```json
"params":{
        "timers":[
            {
                "enabled":1,
                "mId":"847b296e-9043-ac94-ca37-aa5f91d22338",
                "type":"repeat", //重复执行
                "at":"36 8 * * 1,3",//时间表达式参考cron
                "do":{
                    "switch":"on"
                },
                "coolkit_timer_type":"repeat" //重复执行
            }
        ]
    }
```

循环定时: 

```json
"params":{
        "timers":[
            {
                "enabled":1,
                "mId":"847b296e-9043-ac94-ca37-aa5f91d22338",
                "type":"duration", 
                "at":"2018-11-21T10:24:00.980Z 10 5",//循环定时执行时间 循环周期 10分钟 再执行 5分钟
                "startDo":{
                    "switch":"on"  //周期开始执行
                },
                "endDo":{
                    "switch":"off"  //随后再执行
                },
                "coolkit_timer_type":"duration" //重复执行
            }
        ]
    }
```

延时定时（指定在多少分钟后执行，也就是单次执行，只是为了可以快速添加定时器）: 

```json
"params":{
        "timers":[
            {
                "enabled":1,
                "mId":"95303c64-fbb4-f497-1341-c592432d1d0d",
                "type":"once",
                "at":"2017-07-24T09:10:43.223Z",
                "do":{
                    "switch":"on"
                },
                "period":"30",
                "coolkit_timer_type":"delay"  //延时定时
            }
        ]
    }
```


### WebSocket: 查询设备状态

查询设备的状态，比如: 定时器、分享、开关状态等。

参数: 

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| action | string | N | 固定参数: query |
| apikey | string | N | 用户apikey（可从登陆页面获取） |
| deviceid | string | N | 设备ID |
| params | array | N | 字符串数组，指定要查询的参数。如果为空表示查询所有参数 |
| userAgent | string | N | app或者device|
| sequence | string | N | 时间戳精确到毫秒 |
| ts | number | N | 固定参数: 0|

示例: 

```json
{
    "action":"query",
    "deviceid":"1000000001",
    "apikey":"用户APIKEY",
    "sequence": "1585297259553",
    "params":["switch","timers"], // 如果返回为空，可以使用[]查询所有字段状态
  	"ts": 0,
  	"from": "app",
    "userAgent": "app"
}
```

params说明: 

此参数内容来自于协议文档，不同设备不同协议内容，比如 单通道开关只有一个switch，但多通道设备肯定不止一个switch，灯类设备还能调色调光，参数也有所不同。

协议文档需要向对接销售索要，公版易微联APP未对接设备（无UI）的，如果定制需要额外付费，具体内容咨询对接销售。

**响应参数:**

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| error | number | N | 错误码 |
| apikey | string | N | 用户apikey |
| deviceid | string | N | 设备ID |
| params | object | N | 透传参数,服务端不做验证 |

示例: 

```json
{
    "error":0,
    "deviceid":"1000000001",
    "apikey":"***************",
    "params":{
    	"switch":"on",
      ...
    }
}
```

### WebSocket: 分享设备

客户端发送指令给服务端，分享设备给同区域下的其他用户。

说明: 

1. 分享的设备不能被再次分享。
2. 分享时需要被分享方在线，没有接收分享导致超时后，三分钟之后才能再次分享给该用户。
3. 用户接收分享后，没有分享时间限制。
4. 分享成功后被分享用户也可以控制设备，被分享用户不能进行分享、定时、修改设备名称等操作。

参数: 

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| action | string | N | 固定参数: share |
| apikey | string | N | 用户apikey（可从登陆页面获取） |
| deviceid | string | N | 设备ID |
| params | object | N | 分享信息 |
| userAgent | string | N | 固定参数: app |
| sequence | string | N | 时间戳精确到毫秒 |
| selfApkey | string | N | 分享用户的apikey，和前面的apikey保持一致 |
| ts | number | N | 固定参数: 0|

params说明: 

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| uid | string | N | 接收方用户账号（邮箱或者手机号码） |
| deviceName | string | N | 分享者设备名称 |
| permit | number | Y | 权限值之和，采用位移操作计算。 |
| shareTime | number | Y | GMT标准时间，毫秒级，主要用来在客户端显示排序 |
| note | string | N | 分享备注，长度为10个汉字 |

**permit计算规则: 1: 新增定时器；2: 修改定时器；4:删除定时器；8:启用定时器；四者之和为15**

示例: 

```json
{
    "action":"share",
    "apikey":"用户APIKEY",
  	"selfApikey":"用户APIKEY",
    "deviceid":"1000000001",
    "sequence":"1585296084000",
    "userAgent":"app",
    "params":{
        "uid":"+86127123456789",
        "deviceName":"我的设备00001",
        "shareTime": 1585296084000,
        "permit":15,
        "note":"这是一次分享测试"
    }
}
```

**响应参数:**

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| result | number | Y | 1: 账号不存在（服务端处理）；2: 用户接受分享；3: 用户不接受分享；4: 已分享（服务端处理） |
| error | number | N | 错误码 |
| apikey | string | N | 主人端apikey，接收到什么就返回什么 |
| deviceid | string | N | 设备ID |
| sequence | string | N | 时间戳精确到毫秒，接收到什么就返回什么 |

错误码: 

0: 操作成功  
400: 参数错误    
401: 认证不通过  
403: Forbidden（无权限）  
406: 用户在其他设备登录  
504: 分享超时（对方没有拒绝也没有同意）  

**返回示例:**

```json
{
  "error": 0,
  "result": 2,
  "apikey": "主人端APIKEY", // 接收到什么就返回什么
  "deviceid": "1000000001",
  "sequence": "1585296084000" // 接收到什么就返回什么
}
```

### WebSocket: 修改分享

客户端向服务端发送指令，修改接收方对定时器的控制权限。

参数: 

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| action | string | N | 固定参数: updateShare |
| apikey | string | N | 用户apikey（可从登陆页面获取） |
| deviceid | string | N | 设备ID |
| params | object | N | 分享信息 |
| userAgent | string | N | 固定参数: app |
| sequence | string | N | 时间戳精确到毫秒 |
| selfApikey| string | N | 分享用户的apikey，和前面的apikey保持一致 |

params说明: 

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| uid | string | N | 接收方用户账号（邮箱或者手机号码） |
| deviceName | string | N | 分享者设备名称 |
| permit | number | N | 权限值之和，采用位移操作计算。 |
| shareTime | number | N | GMT标准时间，毫秒级，主要用来在客户端显示排序 |
| note | string | N | 分享备注，长度为10个汉字 |

**permit计算规则: 1: 新增定时器；2: 修改定时器；4:删除定时器；8:启用定时器；四者之和为15**

示例: 

```json
{
    "action":"updateShare",
    "apikey":"用户APIKEY",
    "deviceid":"1000000001",
    "sequence": "1585296084000",
    "selfApikey":"用户APIKEY",
    "userAgent":"app",
    "params":{
        "uid":"+86127123456789",
        "deviceName":"我的设备00001",
        "permit":11,
        "note":"这是一次修改分享"
    }
}
```

**响应参数:**

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| result | number | Y | 1: 手机号不存在；2: 用户接受分享；3: 用户不接受分享；4: 已分享 |
| error | number | N | 错误码 |
| apikey | string | Y | 用户apikey |
| deviceid | string | Y | 设备ID |
| sequence | string | Y | 时间戳精确到毫秒，服务器原样返回 |

错误码: 

0: 操作成功  
400: 参数错误  
401: 认证不通过  
403: Forbidden（无权限）  
406: 用户在其他设备登录  
500: Internal Server Error（服务器内部错误）  
504: 分享超时（对方没有拒绝也没有同意）  

**返回示例:**

```json
{
  "error": 0,
  "result": 2,
  "apikey":"用户APIKEY",
  "deviceid": "1000000001",
  "sequence": "1585296084000"
}
```

### WebSocket: 撤销分享

客户端向服务端发送指令，撤销设备分享，分享方撤销分享后，设备会在接收用户app上的设备列表中被删除，失去控制设备的权限。

说明: 撤销分享时，可能已经被撤销过了，此处响应参数不做区分。

参数: 

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| action | string | N | 固定参数: cancelShare |
| apikey | string | N | 用户apikey（可从登陆页面获取） |
| deviceid | string | N | 设备ID |
| params | object | N | 分享信息 |
| userAgent | string | N | 固定参数: app |
| sequence | string | N | 时间戳精确到毫秒 |
| selfApikey | string | 是|分享用户的apikey，和前面的apikey保持一致 |


params说明: 

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| uid | string | N | 接收方用户账号（邮箱或者手机号码） |
| deviceName | string | N | 分享者设备名称 |

示例: 

```json
{
    "action": "cancelShare",
    "apikey": "用户APIKEY",
    "deviceid": "1000000001",
    "sequence": "1585296084000",
    "userAgent": "app",
    "selfApikey": "用户APIKEY",
    "params":{
        "uid": "+86127123456789",
        "deviceName": "我的设备00001",
    }
}
```

**响应参数:**

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| error | number | N | 错误码 |
| sequence | string | Y | 时间戳精确到毫秒，服务器原样返回 |

错误码: 

0: 操作成功

**返回示例:**

```json
{
  "error": 0,
  "result": 2,
  "apikey":"用户APIKEY",
  "deviceid": "1000000001",
  "sequence": 1571141530100
}
```

### HTTP: 查询设备状态

查询设备的状态，比如: 定时器、分享、开关状态等。

- 接口路径: https://{区域}-api.coolkit.cc:8080/api/user/device/status
- 请求方法: get

**请求参数:**

Headers: 

| 名称 | 参数值 | 允许为空 | 示例 |
| :--- | :--- | :--- | :--- |
| Authorization | Bearer+空格+at | N | Bearer 074e8af6f5f10183647a6a4f5b51fdc6788f617a |
| Content-Type | application/json | N | application/json |

Params: 

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| deviceid | string | N | 查询的设备ID |
| appid | string | N | APPID |
| nonce | string | N | 8位字母数字随机数 |
| ts | number | N | 时间戳精确到秒 |
| version | number | N | 接口版本: 8 |
| params | string | Y | 参数列表，指定要查询的参数，用|符号分隔（需要做URI encode）。如果为空，表示查询所有参数 |

示例: 

```json
https://cn-api.coolkit.cn:8080/api/user/device/status?deviceid=1234abcd&params=switch|timers&appid=McFJj4Noke1mGDZCR1QarGW7P9Ycp0Vr&ts=1558004249&version=8&nonce=asbsedwq
```

**响应参数:**

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| error | number | Y | 错误码 |
| errmsg | string | Y | 错误信息，报错才返回 |
| params | object | Y | 设备参数: 状态 |

错误码: 

0: 操作成功  
400: 参数错误  

**返回示例:**

```json
{
    "error":0,
    "params":{
        "switch":"on"
    }
}
```

### HTTP: 更新设备状态

更改设备的状态，比如: 定时器、分享、开关状态等。

- 接口路径: https://{区域}-api.coolkit.cc:8080/api/user/device/status
- 请求方法: post

**请求参数:**

Headers: 

| 名称 | 参数值 | 允许为空 | 示例 |
| :--- | :--- | :--- | :--- |
| Authorization | Bearer+空格+at | N | Bearer 074e8af6f5f10183647a6a4f5b51fdc6788f617a |
| Content-Type | application/json | N | application/json |

Body: 

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| deviceid | string | N | 设备ID |
| params | object | N | 服务端对于params参数采用透传方式，可能是对象也可能是对象数组。只需要发送期望改变的状态参数 |
| appid | string | N | APPID |
| nonce | string | N | 8位字母数字随机数 |
| ts | number | N | 时间戳精确到秒 |
| version | number | N | 接口版本: 8 |

示例: 

```json
{
    "deviceid":"100000001",
	"params": {
		"switch": "on"
    },
    "appid":"McFJj4Noke1mGDZCR1QarGW7P9Ycp0Vr",
    "ts":15452192511,
    "version":8,
    "nonce":"asbsedwq"
}
```

**响应参数:**

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| error | string | N | 错误码 |
| deviceid| string | N | 设备ID |

错误码: 

0: 操作成功  
400: 参数错误  
504: 设备未回应（离线或者指令错误）

**返回示例:**

```json
{
   "error": 0,
   "deviceid":"1000000001"
}
```